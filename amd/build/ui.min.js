define("tiny_chemistry/ui",["exports","tiny_chemistry/modal","core/modal_factory","core/modal_events","tiny_chemistry/options","core/event","tiny_chemistry/repository","core/notification","core/utils","tiny_chemistry/selectors","tiny_chemistry/chemistry"],(function(_exports,_modal,_modal_factory,_modal_events,_options,_event,TinyChemistryRepository,_notification,_utils,_selectors,_chemistry){function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * Tiny Chemistry UI.
   *
   * @module      tiny_chemistry/ui
   * @copyright   adapted for chemistry 2023 TOP Lehre FH OOE, Campus Hagenberg (elearning@fh-hagenberg.at), original based on Huong Nguyen <huongnv13@gmail.com> for equation (2022)
   * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */let currentForm;Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.handleAction=void 0,_modal=_interopRequireDefault(_modal),_modal_factory=_interopRequireDefault(_modal_factory),_modal_events=_interopRequireDefault(_modal_events),TinyChemistryRepository=function(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}newObj.default=obj,cache&&cache.set(obj,newObj);return newObj}(TinyChemistryRepository),_selectors=_interopRequireDefault(_selectors);let lastCursorPos=0;_exports.handleAction=editor=>{displayDialogue(editor)};const displayDialogue=async editor=>{let data={};const currentChemistryData=(0,_chemistry.getCurrentChemistryData)(editor);currentChemistryData&&Object.assign(data,currentChemistryData);const modalPromises=await _modal_factory.default.create({type:_modal.default.TYPE,templateContext:getTemplateContext(editor,data),large:!0});modalPromises.show();const $root=await modalPromises.getRoot(),root=$root[0];currentForm=root.querySelector(_selectors.default.elements.form),$root.on(_modal_events.default.hidden,(()=>{modalPromises.destroy()})),$root.on(_modal_events.default.shown,(()=>{const library=root.querySelector(_selectors.default.elements.library);TinyChemistryRepository.filterChemistry(1,library.innerHTML).then((async data=>(library.innerHTML=data.content,updatePreview(),notifyFilter(library),data))).catch(_notification.displayException)})),root.addEventListener("click",(e=>{const libraryItem=e.target.closest(_selectors.default.elements.libraryItem),submitAction=e.target.closest(_selectors.default.actions.submit),textArea=e.target.closest(".tiny_chemistry_chemistry");libraryItem&&(e.preventDefault(),selectLibraryItem(libraryItem)),submitAction&&(e.preventDefault(),(0,_chemistry.setChemistry)(currentForm,editor),modalPromises.destroy()),textArea&&(0,_utils.debounce)(updatePreview(),500)})),root.addEventListener("keyup",(e=>{e.target.closest(_selectors.default.elements.chemistryTextArea)&&(0,_utils.debounce)(updatePreview(),500)})),root.addEventListener("keydown",(e=>{e.target.closest(_selectors.default.elements.libraryItem)&&(37!=e.keyCode&&39!=e.keyCode||groupNavigation(e))}))},getTemplateContext=(editor,data)=>{const libraries=(0,_options.getLibraries)(editor),texDocsUrl=(0,_options.getTexDocsUrl)(editor);return Object.assign({},{elementid:editor.id,libraries:libraries,texdocsurl:texDocsUrl,delimiters:_selectors.default.delimiters},data)},selectLibraryItem=libraryItem=>{const tex=libraryItem.getAttribute("data-tex"),input=currentForm.querySelector(_selectors.default.elements.chemistryTextArea);let oldValue,newValue,focusPoint=0;oldValue=input.value,newValue=oldValue.substring(0,lastCursorPos)," "!==newValue.charAt(newValue.length-1)&&(newValue+=" "),newValue+=tex,focusPoint=newValue.length," "!==oldValue.charAt(lastCursorPos)&&(newValue+=" "),newValue+=oldValue.substring(lastCursorPos,oldValue.length),input.value=newValue,input.focus(),input.selectionStart=input.selectionEnd=focusPoint,updatePreview()},updatePreview=()=>{const textarea=currentForm.querySelector(_selectors.default.elements.chemistryTextArea),preview=currentForm.querySelector(_selectors.default.elements.preview),cursorLatex=_selectors.default.cursorLatex,isChar=/[a-zA-Z{]/;let currentPos=textarea.selectionStart,chemistry=textarea.value;for(currentPos||(currentPos=0),(0,_chemistry.getSourceChemistry)()&&(currentPos=chemistry.length);"\\"===chemistry.charAt(currentPos)&&currentPos>=0;)currentPos-=1;if(0!==currentPos&&"{"!=chemistry.charAt(currentPos-1))for(;isChar.test(chemistry.charAt(currentPos))&&currentPos<chemistry.length&&isChar.test(chemistry.charAt(currentPos-1));)currentPos+=1;lastCursorPos=currentPos,chemistry=""+chemistry.substring(0,currentPos)+cursorLatex+chemistry.substring(currentPos),chemistry=_selectors.default.delimiters.start+" "+chemistry+" "+_selectors.default.delimiters.end,TinyChemistryRepository.filterChemistry(1,chemistry).then((data=>(preview.innerHTML=data.content,notifyFilter(preview),data))).catch(_notification.displayException)},notifyFilter=element=>{(0,_event.notifyFilterContentUpdated)(element)},groupNavigation=e=>{e.preventDefault();const current=e.target.closest(_selectors.default.elements.libraryItem),parent=current.parentNode,buttons=Array.prototype.slice.call(parent.querySelectorAll(_selectors.default.elements.libraryItem)),direction=37!==e.keyCode?1:-1;let nextButton,index=buttons.indexOf(current);index<0&&(index=0),index+=direction,index<0?index=buttons.length-1:index>=buttons.length&&(index=0),nextButton=buttons[index],nextButton.focus()}}));

//# sourceMappingURL=ui.min.js.map